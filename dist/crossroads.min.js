/*

 Crossroads.js <http://millermedeiros.github.com/crossroads.js>
 Released under the MIT license
 Author: Miller Medeiros
 Version: 0.7.0 - Build: 92 (2011/12/01 01:36 PM)
*/
(function(j){j("crossroads",function(f){function h(a,b){if(a.indexOf)return a.indexOf(b);else{for(var c=a.length;c--;)if(a[c]===b)return c;return-1}}function i(a,b){return"[object "+b+"]"===Object.prototype.toString.call(a)}function j(a){return a===null||a==="null"?null:a==="true"?!0:a==="false"?!1:a===m||a==="undefined"?m:a===""||isNaN(a)?a:parseFloat(a)}function k(){this._routes=[];this.bypassed=new l.Signal;this.routed=new l.Signal}function n(a,b,c,e){var d=i(a,"RegExp");this._router=e;this._pattern=
a;this._paramsIds=d?null:g.getParamIds(this._pattern);this._optionalParamsIds=d?null:g.getOptionalParamsIds(this._pattern);this._matchRegexp=d?a:g.compilePattern(a);this.matched=new l.Signal;b&&this.matched.add(b);this._priority=c||0}var l=f("signals"),g,m;k.prototype={normalizeFn:null,create:function(){return new k},shouldTypecast:!1,addRoute:function(a,b,c){a=new n(a,b,c,this);this._sortedInsert(a);return a},removeRoute:function(a){var b=h(this._routes,a);b!==-1&&this._routes.splice(b,1);a._destroy()},
removeAllRoutes:function(){for(var a=this.getNumRoutes();a--;)this._routes[a]._destroy();this._routes.length=0},parse:function(a){var a=a||"",b=this._getMatchedRoutes(a),c=0,e=b.length,d;if(e)for(;c<e;)d=b[c],d.route.matched.dispatch.apply(d.route.matched,d.params),d.isFirst=!c,this.routed.dispatch(a,d),c+=1;else this.bypassed.dispatch(a);return e>0},getNumRoutes:function(){return this._routes.length},_sortedInsert:function(a){var b=this._routes,c=b.length;do--c;while(b[c]&&a._priority<=b[c]._priority);
b.splice(c+1,0,a)},_getMatchedRoutes:function(a){for(var b=[],c=this._routes,e=c.length,d;d=c[--e];)(!b.length||d.greedy)&&d.match(a)&&b.push({route:d,params:d._getParamsArray(a)});return b},toString:function(){return"[crossroads numRoutes:"+this.getNumRoutes()+"]"}};f=new k;f.VERSION="0.7.0";n.prototype={greedy:!1,rules:void 0,match:function(a){return this._matchRegexp.test(a)&&this._validateParams(a)},linkTo:function(a){if(!this._pattern)throw Error("Cannot link to route with regex pattern");return g.composePath(this._pattern,
a)},_validateParams:function(a){var b=this.rules,c=this._getParamsObject(a),e;for(e in b)if(b.hasOwnProperty(e)&&!this._isValidParam(a,e,c))return!1;return!0},_isValidParam:function(a,b,c){var e=this.rules[b],d=c[b],f=!1;d==null&&this._optionalParamsIds&&h(this._optionalParamsIds,b)!==-1?f=!0:i(e,"RegExp")?f=e.test(d):i(e,"Array")?f=h(e,d)!==-1:i(e,"Function")&&(f=e(d,a,c));return f},_getParamsObject:function(a){for(var b=this._router.shouldTypecast,c=g.getParamValues(a,this._matchRegexp,b),e={},
d=c.length;d--;)e[d]=c[d],this._paramsIds&&(e[this._paramsIds[d]]=c[d]);e.request_=b?j(a):a;e.vals_=c;return e},_getParamsArray:function(a){var b=this.rules?this.rules.normalize_:null;return(b=b||this._router.normalizeFn)&&i(b,"Function")?b(a,this._getParamsObject(a)):g.getParamValues(a,this._matchRegexp,this._router.shouldTypecast)},dispose:function(){this._router.removeRoute(this)},_destroy:function(){this.matched.dispose();this.matched=this._pattern=this._matchRegexp=null},toString:function(){return'[Route pattern:"'+
this._pattern+'", numListeners:'+this.matched.getNumListeners()+"]"}};g=f.patternLexer=function(){function a(a,b){for(var c=[],d;d=a.exec(b);)c.push(d[1]);return c}function b(u){return a(l,u)}function c(a,b,c){a=c.substr(b+a.length);return a===""||a.indexOf("/")===0||a.search(s)===0?"":"/"}function e(a){a=a.replace(g,"$1"+o+"$2");a=a.replace(h,"$1"+p+"$2");a=a.replace(k,q);return a.replace(i,r)}var d=/[\\.+*?\^$\[\](){}\/'#]/g,f=/\/$/g,g=/([:}]|\w(?=\/))\/?(:)/g,h=/([:}])\/?(\{)/g,i=/\{([^}]+)\}/g,
k=/:([^:]+):/g,l=/(?:\{|:)([^}:]+)(?:\}|:)/g,r="__CR_RP__",q="__CR_OP__",p="__CR_RS__",o="__CR_OS__",m=RegExp(r,"g"),n=RegExp(q,"g"),v=RegExp(o,"g"),w=RegExp(p,"g"),s=RegExp(r+"|"+q+"|"+o+"|"+p,"g");return{getParamIds:b,getOptionalParamsIds:function(b){return a(k,b)},getParamValues:function(a,b,c){if(a=b.exec(a)){a.shift();for(var b=a.length,d=[];b--;){var e=d,f=b,g=a[b],t=g;if(typeof g==="string")try{t=decodeURIComponent(g)}catch(h){}e[f]=t}a=d;if(c){c=a;a=c.length;for(b=[];a--;)b[a]=j(c[a]);a=b}}return a},
compilePattern:function(a){if(a=a||"")a=a.replace(f,""),a=e(a),a=a.replace(d,"\\$&"),a=a.replace(v,"\\/?"),a=a.replace(w,"\\/"),a=a.replace(n,"([^\\/]+)?/?"),a=a.replace(m,"([^\\/]+)");return RegExp("^"+a+"/?$")},composePath:function(a,d){a=a||"";d=d||{};if(a)var f=b(a),a=e(a),a=a.replace(s,function(a,b,e){switch(a){case r:var g=d,h=f.shift(),g=g[h];if(!g)throw Error('Missing parameter "'+h+'"');return encodeURIComponent(g)+c(a,b,e);case q:return h=d[f.shift()],(h?"/"+encodeURIComponent(h):"")+c(a,
b,e);case p:return"/";case o:return"";default:throw Error("Unexpected token");}});return a}}}();return f})})(typeof define==="function"&&define.amd?define:function(j,f){typeof module!=="undefined"&&module.exports?module.exports=f(require):window[j]=f(function(f){return window[f]})});